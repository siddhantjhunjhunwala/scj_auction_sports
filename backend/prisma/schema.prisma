generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  player
  auctioneer
}

enum PlayerType {
  batsman
  bowler
  wicketkeeper
  allrounder
}

enum AuctionStatus {
  not_started
  in_progress
  paused
  completed
}

enum LeagueMode {
  pre_auction
  auction
  scoring
  subs
  report
}

enum GameStatus {
  pre_auction
  auction_active
  auction_paused
  auction_ended
  scoring
  completed
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  name            String
  teamName        String?
  avatarUrl       String?
  role            UserRole  @default(player)
  budgetRemaining Float     @default(200.00)
  createdAt       DateTime  @default(now())

  // Relations
  cricketers      Cricketer[]  @relation("PickedBy")
  bids            Bid[]
  substitutions   Substitution[]
  highBidAuction  AuctionState? @relation("HighBidder")
  currentSubTurn  LeagueState?  @relation("CurrentSubUser")

  // Multi-game relations
  createdGames       Game[]           @relation("GameCreator")
  gameParticipations GameParticipant[]

  @@map("users")
}

model Cricketer {
  id              String      @id @default(uuid())
  firstName       String
  lastName        String
  playerType      PlayerType
  isForeign       Boolean     @default(false)
  iplTeam         String
  battingRecord   Json?
  bowlingRecord   Json?
  pictureUrl      String?
  newsArticles    Json?       @default("[]")
  isPicked        Boolean     @default(false)
  pickedByUserId  String?
  pricePaid       Float?
  pickOrder       Int?
  wasSkipped      Boolean     @default(false)
  auctionOrder    Int?

  // Relations
  pickedBy           User?              @relation("PickedBy", fields: [pickedByUserId], references: [id])
  bids               Bid[]
  matchScores        PlayerMatchScore[]
  currentAuction     AuctionState?      @relation("CurrentCricketer")
  substitutionsOut   Substitution[]     @relation("SubOut")
  substitutionsIn    Substitution[]     @relation("SubIn")

  @@map("cricketers")
}

model Bid {
  id          String   @id @default(uuid())
  cricketerId String
  userId      String
  amount      Float
  timestamp   DateTime @default(now())

  // Relations
  cricketer Cricketer @relation(fields: [cricketerId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@map("bids")
}

model Match {
  id              String   @id @default(uuid())
  matchNumber     Int      @unique
  team1           String
  team2           String
  matchDate       DateTime
  scoresPopulated Boolean  @default(false)
  isAutoPopulated Boolean  @default(false)

  // Relations
  scores PlayerMatchScore[]

  @@map("matches")
}

model PlayerMatchScore {
  id                   String   @id @default(uuid())
  matchId              String
  cricketerId          String
  inPlayingXi          Boolean  @default(true)
  runs                 Int      @default(0)
  ballsFaced           Int      @default(0)
  fours                Int      @default(0)
  sixes                Int      @default(0)
  wickets              Int      @default(0)
  oversBowled          Float    @default(0)
  runsConceded         Int      @default(0)
  maidens              Int      @default(0)
  dotBalls             Int      @default(0)
  catches              Int      @default(0)
  stumpings            Int      @default(0)
  directRunouts        Int      @default(0)
  indirectRunouts      Int      @default(0)
  dismissalType        String?
  lbwBowledDismissals  Int      @default(0)
  calculatedPoints     Int      @default(0)

  // Relations
  match     Match     @relation(fields: [matchId], references: [id])
  cricketer Cricketer @relation(fields: [cricketerId], references: [id])

  @@unique([matchId, cricketerId])
  @@map("player_match_scores")
}

model Substitution {
  id                String   @id @default(uuid())
  userId            String
  subOutCricketerId String
  subInCricketerId  String
  subRound          Int
  createdAt         DateTime @default(now())

  // Relations
  user         User      @relation(fields: [userId], references: [id])
  subOutPlayer Cricketer @relation("SubOut", fields: [subOutCricketerId], references: [id])
  subInPlayer  Cricketer @relation("SubIn", fields: [subInCricketerId], references: [id])

  @@map("substitutions")
}

model AuctionState {
  id                   String        @id @default(uuid())
  currentCricketerId   String?       @unique
  auctionStatus        AuctionStatus @default(not_started)
  timerEndTime         DateTime?
  timerPausedAt        DateTime?
  currentHighBid       Float         @default(0)
  currentHighBidderId  String?       @unique
  isFirstRound         Boolean       @default(true)

  // Relations
  currentCricketer  Cricketer? @relation("CurrentCricketer", fields: [currentCricketerId], references: [id])
  currentHighBidder User?      @relation("HighBidder", fields: [currentHighBidderId], references: [id])

  @@map("auction_state")
}

model LeagueState {
  id                String     @id @default(uuid())
  mode              LeagueMode @default(pre_auction)
  subsPeriodActive  Boolean    @default(false)
  currentSubUserId  String?    @unique
  currentSubRound   Int?

  // Relations
  currentSubUser User? @relation("CurrentSubUser", fields: [currentSubUserId], references: [id])

  @@map("league_state")
}

// ========================
// MULTI-GAME MODELS
// ========================

model Game {
  id                 String      @id @default(uuid())
  name               String
  code               String      @unique
  createdById        String
  status             GameStatus  @default(pre_auction)
  joiningAllowed     Boolean     @default(true)
  cricketersUploaded Boolean     @default(false)
  createdAt          DateTime    @default(now())

  // Relations
  creator       User              @relation("GameCreator", fields: [createdById], references: [id])
  participants  GameParticipant[]
  cricketers    GameCricketer[]
  auctionState  GameAuctionState?
  bids          GameBid[]
  matches       GameMatch[]
  pointsConfig  PointSystemConfig?

  @@map("games")
}

model GameParticipant {
  id              String   @id @default(uuid())
  gameId          String
  userId          String
  budgetRemaining Float    @default(200.00)
  joinedAt        DateTime @default(now())

  // Relations
  game       Game            @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id])
  cricketers GameCricketer[] @relation("PickedByParticipant")
  bids       GameBid[]

  @@unique([gameId, userId])
  @@map("game_participants")
}

model GameCricketer {
  id            String     @id @default(uuid())
  gameId        String
  firstName     String
  lastName      String
  playerType    PlayerType
  isForeign     Boolean    @default(false)
  iplTeam       String
  battingRecord Json?
  bowlingRecord Json?
  pictureUrl    String?

  isPicked              Boolean  @default(false)
  pickedByParticipantId String?
  pricePaid             Float?
  pickOrder             Int?
  wasSkipped            Boolean  @default(false)
  auctionOrder          Int?

  // Relations
  game           Game              @relation(fields: [gameId], references: [id], onDelete: Cascade)
  pickedBy       GameParticipant?  @relation("PickedByParticipant", fields: [pickedByParticipantId], references: [id])
  bids           GameBid[]
  matchScores    GamePlayerMatchScore[]
  currentAuction GameAuctionState? @relation("CurrentGameCricketer")

  @@map("game_cricketers")
}

model GameAuctionState {
  id                   String        @id @default(uuid())
  gameId               String        @unique
  currentCricketerId   String?       @unique
  auctionStatus        AuctionStatus @default(not_started)
  timerEndTime         DateTime?
  timerPausedAt        DateTime?
  currentHighBid       Float         @default(0)
  currentHighBidderId  String?
  isFirstRound         Boolean       @default(true)
  currentBiddingLog    Json          @default("[]")
  lastWinMessage       String?

  // Relations
  game             Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  currentCricketer GameCricketer? @relation("CurrentGameCricketer", fields: [currentCricketerId], references: [id])

  @@map("game_auction_states")
}

model GameBid {
  id            String   @id @default(uuid())
  gameId        String
  cricketerId   String
  participantId String
  amount        Float
  timestamp     DateTime @default(now())

  // Relations
  game        Game            @relation(fields: [gameId], references: [id], onDelete: Cascade)
  cricketer   GameCricketer   @relation(fields: [cricketerId], references: [id])
  participant GameParticipant @relation(fields: [participantId], references: [id])

  @@map("game_bids")
}

model GameMatch {
  id              String   @id @default(uuid())
  gameId          String
  matchNumber     Int
  team1           String
  team2           String
  matchDate       DateTime
  scoresPopulated Boolean  @default(false)
  isAutoPopulated Boolean  @default(false)

  // Relations
  game   Game                   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  scores GamePlayerMatchScore[]

  @@unique([gameId, matchNumber])
  @@map("game_matches")
}

model GamePlayerMatchScore {
  id                  String  @id @default(uuid())
  gameMatchId         String
  cricketerId         String
  inPlayingXi         Boolean @default(true)
  runs                Int     @default(0)
  ballsFaced          Int     @default(0)
  fours               Int     @default(0)
  sixes               Int     @default(0)
  wickets             Int     @default(0)
  oversBowled         Float   @default(0)
  runsConceded        Int     @default(0)
  maidens             Int     @default(0)
  dotBalls            Int     @default(0)
  catches             Int     @default(0)
  stumpings           Int     @default(0)
  directRunouts       Int     @default(0)
  indirectRunouts     Int     @default(0)
  dismissalType       String?
  lbwBowledDismissals Int     @default(0)
  calculatedPoints    Int     @default(0)

  // Relations
  match     GameMatch     @relation(fields: [gameMatchId], references: [id], onDelete: Cascade)
  cricketer GameCricketer @relation(fields: [cricketerId], references: [id])

  @@unique([gameMatchId, cricketerId])
  @@map("game_player_match_scores")
}

model PointSystemConfig {
  id     String @id @default(uuid())
  gameId String @unique

  // Batting
  runPoints    Int @default(1)
  fourBonus    Int @default(4)
  sixBonus     Int @default(6)
  runs25Bonus  Int @default(4)
  runs50Bonus  Int @default(8)
  runs75Bonus  Int @default(12)
  runs100Bonus Int @default(16)
  duckPenalty  Int @default(-2)
  sr130Bonus   Int @default(2)
  sr150Bonus   Int @default(4)
  sr170Bonus   Int @default(6)

  // Bowling
  wicketPoints   Int @default(25)
  lbwBowledBonus Int @default(8)
  maidenPoints   Int @default(6)
  dotBallPoints  Int @default(1)
  wickets3Bonus  Int @default(4)
  wickets4Bonus  Int @default(8)
  wickets5Bonus  Int @default(12)
  econ5Bonus     Int @default(6)
  econ6Bonus     Int @default(4)
  econ7Bonus     Int @default(2)

  // Fielding
  catchPoints    Int @default(8)
  catches3Bonus  Int @default(4)
  stumpingPoints Int @default(12)
  directRunout   Int @default(12)
  indirectRunout Int @default(6)
  playingXiBonus Int @default(4)

  // Relations
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@map("point_system_configs")
}
